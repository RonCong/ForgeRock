#! /bin/bash
source opendj.properities
sudo mkdir /opt/ldapdb/$dbpath/db
sudo mkdir /opt/ldaplogs/$logpath/logs
sudo chown rong_cong:rong_cong /opt/ldapdb/$dbpath/db
sudo chown rong_cong:rong_cong /opt/ldaplogs/$logpath/logs
sudo chmod 744 /opt/ldapdb/$dbpath/db
sudo chmod 744 /opt/ldaplogs/$logpath/logs


echo "How do you want to name DS?(Follow the format 'ds_<regionCode>
<appname>_<environmentType>')"
read dsname
echo "dsname=$dsname" >> /opt/script/opendj.properities
if [ -d "$home/$dsname" ]; then
       echo "Directory exists"
else
       if [ -d "$home/opendj" ]; then
               sudo mv "$home/opendj" "$home/$dsname"
               echo "Create successful"
       else
               for file in $home; do
                       if [[ $file=="DS-7"* ]] && [[ $file==*".zip" ]];then
                               sudo unzip $home/DS-7*.zip -d $home
                               sudo mv "$home/opendj" "$home/$dsname"
                               echo "Create successful"
                       else
                               echo "No ForgeRock DS file exists, Pls download"
                               exit 1
                       fi
               done
       fi      
fi

sudo chown -R rong_cong:rong_cong $home/$dsname
sudo chmod -R 744 $home/$dsname
cd $home/$dsname/bin
deployID=$(./dskeymgr create-deployment-id --deploymentIdPassword password)
echo "The Deployment ID is $deployID"
echo "DEPLOYMENT_ID=$deployID" >> /opt/script/opendj.properities

if [ -f "$home/$dsname/setup" ]; then
        echo "start setup"
        # Execute the .sh file
        cd $home/$dsname/
        bash setup \
 --serverId evaluation-only \
 --deploymentId $DEPLOYMENT_ID \
 --deploymentIdPassword password \
 --rootUserDN cn="Directory Manager" \
 --rootUserPassword password \
 --monitorUserDn uid=monitor \
 --monitorUserPassword password \
 --hostname localhost \
 --adminConnectorPort 5555 \
 --ldapPort 1389 \
 --enableStartTls \
 --ldapsPort 1636 \
 --httpsPort 9443 \
 --replicationPort 8989 \
 --bootstrapReplicationServer localhost:8989 \
 --profile ds-evaluation \
 --start \
 --acceptLicense
else
        echo "Errorï¼š/$dsname/setup does not exist."

fi

echo "Creating backend database."
cd $home/$dsname/bin/
bash dsconfig \
create-backend \
 --hostname localhost \
 --port 5555 \
 --bindDn cn="Directory Manager" \
 --bindPassword password \
 --backend-name userRoot \
 --db-directory $home/opt/ldapdb/$dbpath/db
 --type je \
 --set enabled:true \
 --set base-dn:dc=example,dc=com \
 --usePkcs12TrustStore $home/$dsname/config/keystore \
 --trustStorePassword:file $home/$dsname/config/keystore.pin \
 --no-prompt

